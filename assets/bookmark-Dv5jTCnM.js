import{c as ce,i as de}from"./lucide-iiCyoXQ9.js";import"./mobileMenu-95gHE_Cx.js";import"./full-width-B8_sb6NU.js";import"./version-CEpUk6qs.js";import{G as _e,t as Ve,P as Qe,g as et,b as v,e as tt,i as nt,j as le}from"./shortcuts-CaOq6dM1.js";import{i as ot}from"./shortcuts-init-cT1Qr9ko.js";_e.workerSrc=new URL("/assets/pdf.worker.min-qwK7q_zL.mjs",import.meta.url).toString();const j=document.getElementById("modal-container");let ie=!1,re=null,X=null,ae=null,Se=null,U=1;function Ee(e,t=[],n={}){return new Promise(o=>{const i=document.createElement("div");i.className="modal-overlay",i.id="active-modal-overlay";const l=document.createElement("div");l.className="modal-content",l.id="active-modal";const x=t.map(s=>{if(s.type==="text")return`
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">${s.label}</label>
                                <input type="text" id="modal-${s.name}" value="${We(n[s.name]||"")}" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg" 
                                    placeholder="${s.placeholder||""}" />
                            </div>
                        `;if(s.type==="select")return`
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">${s.label}</label>
                                <select id="modal-${s.name}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    ${s.options.map(a=>`
                                        <option value="${a.value}" ${n[s.name]===a.value?"selected":""}>
                                            ${a.label}
                                        </option>
                                    `).join("")}
                                </select>
                                ${s.name==="color"?'<input type="color" id="modal-color-picker" class="hidden w-full h-10 mt-2 rounded cursor-pointer border border-gray-300" value="#000000" />':""}
                            </div>
                        `;if(s.type==="destination"){const a=n.destX!==null&&n.destX!==void 0;return`
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">${s.label}</label>
                                <div class="p-3 bg-gray-50 rounded-lg border border-gray-200 space-y-2">
                                    <div class="flex items-center gap-2">
                                        <label class="flex items-center gap-1 text-xs">
                                            <input type="checkbox" id="modal-use-destination" class="w-4 h-4" ${a?"checked":""}>
                                            <span>Set custom destination</span>
                                        </label>
                                    </div>
                                    <div id="destination-controls" class="${a?"":"hidden"} space-y-2">
                                        <div class="grid grid-cols-2 gap-2">
                                            <div>
                                                <label class="text-xs text-gray-600">Page</label>
                                                <input type="number" id="modal-dest-page" min="1" max="${s.maxPages||1}" value="${n.destPage||s.page||1}" 
                                                    class="w-full px-2 py-1 border border-gray-300 rounded text-sm" step="1" />
                                            </div>
                                            <div>
                                                <label class="text-xs text-gray-600">Zoom (%)</label>
                                                <select id="modal-dest-zoom" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                                    <option value="">Inherit</option>
                                                    <option value="0">Fit Page</option>
                                                    <option value="50">50%</option>
                                                    <option value="75">75%</option>
                                                    <option value="100">100%</option>
                                                    <option value="125">125%</option>
                                                    <option value="150">150%</option>
                                                    <option value="200">200%</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2">
                                            <div>
                                                <label class="text-xs text-gray-600">X Position</label>
                                                <input type="number" id="modal-dest-x" value="0" step="10"
                                                    class="w-full px-2 py-1 border border-gray-300 rounded text-sm" />
                                            </div>
                                            <div>
                                                <label class="text-xs text-gray-600">Y Position</label>
                                                <input type="number" id="modal-dest-y" value="0" step="10"
                                                    class="w-full px-2 py-1 border border-gray-300 rounded text-sm" />
                                            </div>
                                        </div>
                                        <button id="modal-pick-destination" class="w-full px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded text-xs flex items-center justify-center gap-1">
                                            <i data-lucide="crosshair" class="w-3 h-3"></i> Click on PDF to Pick Location
                                        </button>
                                        <p class="text-xs text-gray-500 italic">Click the button above, then click on the PDF where you want the bookmark to jump to</p>
                                    </div>
                                </div>
                            </div>
                        `}else if(s.type==="preview")return`
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">${s.label}</label>
                                <div id="modal-preview" class="style-preview bg-gray-50">
                                    <span id="preview-text" style="font-size: 16px;">Preview Text</span>
                                </div>
                            </div>
                        `;return""}).join("");l.innerHTML=`
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">${e}</h3>
                        <div class="mb-6">
                            ${x}
                        </div>
                        <div class="flex gap-2 justify-end">
                            <button id="modal-cancel" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">Cancel</button>
                            <button id="modal-confirm" class="px-4 py-2 rounded bg-blue-500 hover:bg-blue-600 text-white">Confirm</button>
                        </div>
                    </div>
                `,i.appendChild(l),j.appendChild(i);function f(){const s=l.querySelector("#preview-text");if(s){const a=l.querySelector("#modal-title"),m=l.querySelector("#modal-color"),g=l.querySelector("#modal-style"),L=l.querySelector("#modal-color-picker"),I=a?a.value:"Preview Text",Y=m?m.value:"",z=g?g.value:"";s.textContent=I||"Preview Text";const Ge={red:"#dc2626",blue:"#2563eb",green:"#16a34a",yellow:"#ca8a04",purple:"#9333ea"};Y==="custom"&&L?s.style.color=L.value:s.style.color=Ge[Y]||"#000",s.style.fontWeight=z==="bold"||z==="bold-italic"?"bold":"normal",s.style.fontStyle=z==="italic"||z==="bold-italic"?"italic":"normal"}}const c=l.querySelector("#modal-title"),b=l.querySelector("#modal-color"),d=l.querySelector("#modal-style");c&&c.addEventListener("input",f),b&&b.addEventListener("change",s=>{const a=l.querySelector("#modal-color-picker");s.target.value==="custom"&&a?(a.classList.remove("hidden"),setTimeout(()=>a.click(),100)):a&&a.classList.add("hidden"),f()});const p=l.querySelector("#modal-color-picker");p&&p.addEventListener("input",f),d&&d.addEventListener("change",f);const h=l.querySelector("#modal-use-destination"),u=l.querySelector("#destination-controls"),r=l.querySelector("#modal-pick-destination");if(h&&u&&(h.addEventListener("change",s=>{u.classList.toggle("hidden",!s.target.checked)}),n.destX!==null&&n.destX!==void 0)){const s=l.querySelector("#modal-dest-page"),a=l.querySelector("#modal-dest-x"),m=l.querySelector("#modal-dest-y"),g=l.querySelector("#modal-dest-zoom");s&&n.destPage!==void 0&&(s.value=n.destPage),a&&n.destX!==null&&(a.value=Math.round(n.destX)),m&&n.destY!==null&&(m.value=Math.round(n.destY)),g&&n.zoom!==null&&(g.value=n.zoom||"")}r&&r.addEventListener("click",()=>{ae=i,i.style.display="none",lt((s,a,m)=>{const g=l.querySelector("#modal-dest-page"),L=l.querySelector("#modal-dest-x"),I=l.querySelector("#modal-dest-y");g&&(g.value=s),L&&(L.value=Math.round(a)),I&&(I.value=Math.round(m)),i.style.display="",setTimeout(()=>{E()},100)})});const y=l.querySelector("#modal-dest-page");y&&(y.addEventListener("input",s=>{const a=parseInt(s.target.value),m=parseInt(s.target.max)||1;isNaN(a)||a<1?s.target.value=1:a>m?s.target.value=m:s.target.value=Math.floor(a),E()}),y.addEventListener("blur",s=>{const a=parseInt(s.target.value),m=parseInt(s.target.max)||1;isNaN(a)||a<1?s.target.value=1:a>m?s.target.value=m:s.target.value=Math.floor(a),E()}));function E(){if(!T)return;const s=l.querySelector("#modal-dest-page"),a=l.querySelector("#modal-dest-x"),m=l.querySelector("#modal-dest-y"),g=l.querySelector("#modal-dest-zoom"),L=s?parseInt(s.value):N,I=a?parseFloat(a.value):null,Y=m?parseFloat(m.value):null,z=g?g.value:null;L>=1&&L<=T.numPages&&je(L,I,Y,z)}const S=l.querySelector("#modal-dest-x"),M=l.querySelector("#modal-dest-y"),P=l.querySelector("#modal-dest-zoom");S&&S.addEventListener("input",E),M&&M.addEventListener("input",E),P&&P.addEventListener("change",E),f(),l.querySelector("#modal-cancel").addEventListener("click",()=>{V(),j.removeChild(i),o(null)}),l.querySelector("#modal-confirm").addEventListener("click",()=>{const s={};t.forEach(L=>{if(L.type!=="preview"&&L.type!=="destination"){const I=l.querySelector(`#modal-${L.name}`);s[L.name]=I.value}});const a=l.querySelector("#modal-color"),m=l.querySelector("#modal-color-picker");a&&a.value==="custom"&&m&&(s.color=m.value);const g=l.querySelector("#modal-use-destination");if(g&&g.checked){const L=l.querySelector("#modal-dest-page"),I=l.querySelector("#modal-dest-x"),Y=l.querySelector("#modal-dest-y"),z=l.querySelector("#modal-dest-zoom");s.destPage=L?parseInt(L.value):null,s.destX=I?parseFloat(I.value):null,s.destY=Y?parseFloat(Y.value):null,s.zoom=z&&z.value?z.value:null}else s.destPage=null,s.destX=null,s.destY=null,s.zoom=null;V(),j.removeChild(i),o(s)}),i.addEventListener("click",s=>{s.target===i&&(V(),j.removeChild(i),o(null))}),setTimeout(()=>{const s=l.querySelector("input, select");s&&s.focus()},0),ce({icons:de})})}function lt(e){ie=!0,re=e;const t=document.getElementById("pdf-canvas-wrapper"),n=document.getElementById("picking-mode-banner");t.classList.add("picking-mode"),n.classList.remove("hidden"),window.innerWidth<1024&&document.getElementById("show-viewer-btn").click(),ce({icons:de})}function V(){ie=!1,re=null;const e=document.getElementById("pdf-canvas-wrapper"),t=document.getElementById("picking-mode-banner");e.classList.remove("picking-mode"),t.classList.add("hidden"),X&&(X.remove(),X=null);const n=document.getElementById("destination-coord-display");n&&n.remove(),ae&&(ae.style.display="",ae=null)}document.addEventListener("DOMContentLoaded",()=>{ot();const e=document.getElementById("pdf-canvas"),t=document.getElementById("pdf-canvas-wrapper"),n=document.getElementById("cancel-picking-btn");let o=null;t.addEventListener("mousemove",i=>{if(!ie)return;const l=e.getBoundingClientRect(),x=i.clientX-l.left,f=i.clientY-l.top;o||(o=document.createElement("div"),o.className="coordinate-tooltip",t.appendChild(o)),o.textContent=`X: ${Math.round(x)}, Y: ${Math.round(f)}`,o.style.left=i.clientX-l.left+15+"px",o.style.top=i.clientY-l.top+15+"px"}),t.addEventListener("mouseleave",()=>{o&&(o.remove(),o=null)}),e.addEventListener("click",async i=>{if(!ie||!re)return;const l=e.getBoundingClientRect(),x=i.clientX-l.left,f=i.clientY-l.top;let c=Se;c||(c=(await T.getPage(N)).getViewport({scale:U}));const b=c.width/l.width,d=c.height/l.height,p=x*b,h=c.height-f*d;X&&X.remove();const u=document.getElementById("destination-coord-display");u&&u.remove(),X=document.createElement("div"),X.className="destination-marker",X.innerHTML=`
                    <svg viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2">
                        <circle cx="12" cy="12" r="10" fill="#3b82f6" fill-opacity="0.2"/>
                        <path d="M12 2 L12 22 M2 12 L22 12"/>
                        <circle cx="12" cy="12" r="2" fill="#3b82f6"/>
                    </svg>
                `;const r=e.getBoundingClientRect(),y=t.getBoundingClientRect();X.style.position="absolute",X.style.left=x+r.left-y.left+"px",X.style.top=f+r.top-y.top+"px",t.appendChild(X);const E=document.createElement("div");E.id="destination-coord-display",E.className="absolute bg-blue-500 text-white px-2 py-1 rounded text-xs font-mono z-50 pointer-events-none",E.style.left=x+r.left-y.left+20+"px",E.style.top=f+r.top-y.top-30+"px",E.textContent=`X: ${Math.round(p)}, Y: ${Math.round(h)}`,t.appendChild(E),re(N,p,h),setTimeout(()=>{V()},500)}),n&&n.addEventListener("click",()=>{V()})});function ee(e){return new Promise(t=>{const n=document.createElement("div");n.className="modal-overlay";const o=document.createElement("div");o.className="modal-content",o.innerHTML=`
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Confirm Action</h3>
                        <p class="text-gray-600 mb-6">${e}</p>
                        <div class="flex gap-2 justify-end">
                            <button id="modal-cancel" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">Cancel</button>
                            <button id="modal-confirm" class="px-4 py-2 rounded bg-blue-500 hover:bg-blue-600 text-white">Confirm</button>
                        </div>
                    </div>
                `,n.appendChild(o),j.appendChild(n),o.querySelector("#modal-cancel").addEventListener("click",()=>{j.removeChild(n),t(!1)}),o.querySelector("#modal-confirm").addEventListener("click",()=>{j.removeChild(n),t(!0)}),n.addEventListener("click",i=>{i.target===n&&(j.removeChild(n),t(!1))})})}function q(e,t){return new Promise(n=>{const o=document.createElement("div");o.className="modal-overlay";const i=document.createElement("div");i.className="modal-content",i.innerHTML=`
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">${e}</h3>
                        <p class="text-gray-600 mb-6">${t}</p>
                        <div class="flex justify-end">
                            <button id="modal-ok" class="px-4 py-2 rounded bg-blue-500 hover:bg-blue-600 text-white">OK</button>
                        </div>
                    </div>
                `,o.appendChild(i),j.appendChild(o),i.querySelector("#modal-ok").addEventListener("click",()=>{j.removeChild(o),n(!0)}),o.addEventListener("click",l=>{l.target===o&&(j.removeChild(o),n(!0))})})}const be=document.getElementById("file-input"),Ce=document.getElementById("csv-input"),Pe=document.getElementById("json-input"),st=document.getElementById("auto-extract-checkbox"),De=document.getElementById("app"),Ne=document.getElementById("uploader"),se=document.getElementById("file-display-area"),we=document.getElementById("back-to-tools"),Le=document.getElementById("back-btn"),_=document.getElementById("pdf-canvas"),w=_.getContext("2d"),at=document.getElementById("page-indicator"),it=document.getElementById("prev-page"),rt=document.getElementById("next-page"),ue=document.getElementById("goto-page"),Me=document.getElementById("goto-btn"),ct=document.getElementById("zoom-in-btn"),dt=document.getElementById("zoom-out-btn"),ut=document.getElementById("zoom-fit-btn"),Ie=document.getElementById("zoom-indicator"),ze=document.getElementById("add-top-level-btn"),he=document.getElementById("bookmark-title"),fe=document.getElementById("bookmark-tree-list"),Be=document.getElementById("no-bookmarks"),mt=document.getElementById("download-btn"),Te=document.getElementById("undo-btn"),$e=document.getElementById("redo-btn"),pt=document.getElementById("reset-btn"),gt=document.getElementById("delete-all-btn"),ft=document.getElementById("search-bookmarks"),ht=document.getElementById("import-dropdown-btn"),yt=document.getElementById("export-dropdown-btn"),te=document.getElementById("import-dropdown"),ne=document.getElementById("export-dropdown"),vt=document.getElementById("import-csv-btn"),bt=document.getElementById("export-csv-btn"),kt=document.getElementById("import-json-btn"),xt=document.getElementById("export-json-btn"),ye=document.getElementById("csv-import-hidden"),ve=document.getElementById("json-import-hidden"),Et=document.getElementById("extract-existing-btn"),wt=document.getElementById("current-page-display"),Lt=document.getElementById("filename-display"),It=document.getElementById("batch-mode-checkbox"),ke=document.getElementById("batch-operations"),Bt=document.getElementById("selected-count"),St=document.getElementById("batch-color-select"),Ct=document.getElementById("batch-style-select"),Pt=document.getElementById("batch-delete-btn"),Dt=document.getElementById("select-all-btn"),Nt=document.getElementById("deselect-all-btn"),Mt=document.getElementById("expand-all-btn"),zt=document.getElementById("collapse-all-btn"),R=document.getElementById("show-viewer-btn"),H=document.getElementById("show-bookmarks-btn"),me=document.getElementById("viewer-section"),pe=document.getElementById("bookmarks-section");function Tt(){window.innerWidth>=1024&&(me.classList.remove("hidden"),pe.classList.remove("hidden"),R.classList.remove("bg-indigo-600","text-white"),R.classList.add("text-gray-300"),H.classList.remove("bg-indigo-600","text-white"),H.classList.add("text-gray-300"))}window.addEventListener("resize",Tt);R.addEventListener("click",()=>{me.classList.remove("hidden"),pe.classList.add("hidden"),R.classList.add("bg-indigo-600","text-white"),R.classList.remove("text-gray-300"),H.classList.remove("bg-indigo-600","text-white"),H.classList.add("text-gray-300")});H.addEventListener("click",()=>{me.classList.add("hidden"),pe.classList.remove("hidden"),H.classList.add("bg-indigo-600","text-white"),H.classList.remove("text-gray-300"),R.classList.remove("bg-indigo-600","text-white"),R.classList.add("text-gray-300")});ht.addEventListener("click",e=>{e.stopPropagation(),te.classList.toggle("hidden"),ne.classList.add("hidden")});yt.addEventListener("click",e=>{e.stopPropagation(),ne.classList.toggle("hidden"),te.classList.add("hidden")});document.addEventListener("click",()=>{te.classList.add("hidden"),ne.classList.add("hidden")});let D=null,T=null,N=1,oe="",k=[],A=[],$=-1,W="",G=null,Q=null,Z=!1,C=new Set,J=new Set;const $t={red:"bg-red-100 border-red-300",blue:"bg-blue-100 border-blue-300",green:"bg-green-100 border-green-300",yellow:"bg-yellow-100 border-yellow-300",purple:"bg-purple-100 border-purple-300"};function O(){A=A.slice(0,$+1),A.push(JSON.parse(JSON.stringify(k))),$++,xe()}function qe(){$>0&&($--,k=JSON.parse(JSON.stringify(A[$])),B(),xe())}function Xe(){$<A.length-1&&($++,k=JSON.parse(JSON.stringify(A[$])),B(),xe())}function xe(){Te.disabled=$<=0,$e.disabled=$>=A.length-1}Te.addEventListener("click",qe);$e.addEventListener("click",Xe);pt.addEventListener("click",async()=>{await ee("Reset and go back to file uploader? All unsaved changes will be lost.")&&Oe()});gt.addEventListener("click",async()=>{if(k.length===0){await q("Info","No bookmarks to delete.");return}await ee(`Delete all ${k.length} bookmark(s)?`)&&(k=[],C.clear(),K(),O(),B())});function Oe(){D=null,T=null,N=1,oe="",k=[],A=[],$=-1,W="",G=null,Q=null,Z=!1,C.clear(),J.clear(),be.value="",Ce.value="",Pe.value="",De.classList.add("hidden"),Ne.classList.remove("hidden"),me.classList.remove("hidden"),pe.classList.add("hidden"),R.classList.add("bg-indigo-600","text-white"),R.classList.remove("text-gray-300"),H.classList.remove("bg-indigo-600","text-white"),H.classList.add("text-gray-300")}document.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&(e.key==="z"&&!e.shiftKey?(e.preventDefault(),qe()):(e.key==="z"&&e.shiftKey||e.key==="y")&&(e.preventDefault(),Xe()))});It.addEventListener("change",e=>{Z=e.target.checked,Z||(C.clear(),K()),ke.classList.toggle("hidden",!Z||C.size===0),B()});function K(){Bt.textContent=C.size,Z&&ke.classList.toggle("hidden",C.size===0)}Dt.addEventListener("click",()=>{const e=t=>{let n=[];return t.forEach(o=>{n.push(o.id),o.children.length>0&&(n=n.concat(e(o.children)))}),n};e(k).forEach(t=>C.add(t)),K(),B()});Nt.addEventListener("click",()=>{C.clear(),K(),B()});St.addEventListener("change",e=>{if(e.target.value&&C.size>0){const t=e.target.value==="null"?null:e.target.value;Ye(n=>n.color=t),e.target.value=""}});Ct.addEventListener("change",e=>{if(e.target.value&&C.size>0){const t=e.target.value==="null"?null:e.target.value;Ye(n=>n.style=t),e.target.value=""}});Pt.addEventListener("click",async()=>{if(C.size===0||!await ee(`Delete ${C.size} bookmark(s)?`))return;const t=n=>n.filter(o=>C.has(o.id)?!1:(o.children=t(o.children),!0));k=t(k),C.clear(),K(),O(),B()});function Ye(e){const t=n=>n.map(o=>(C.has(o.id)&&e(o),o.children=t(o.children),o));k=t(k),O(),B()}Mt.addEventListener("click",()=>{J.clear(),B()});zt.addEventListener("click",()=>{const e=t=>{t.forEach(n=>{n.children.length>0&&(J.add(n.id),e(n.children))})};e(k),B()});function qt(e){if(e===0)return"0 Bytes";const t=1024,n=["Bytes","KB","MB","GB"],o=Math.floor(Math.log(e)/Math.log(t));return Math.round(e/Math.pow(t,o)*100)/100+" "+n[o]}function Xt(e){if(!se)return;se.innerHTML="",se.classList.remove("hidden");const t=document.createElement("div");t.className="flex items-center justify-between bg-gray-700 p-3 rounded-lg text-sm";const n=document.createElement("span");n.className="truncate font-medium text-gray-200",n.textContent=e.name;const o=document.createElement("span");o.className="flex-shrink-0 ml-4 text-gray-400",o.textContent=qt(e.size),t.append(n,o),se.appendChild(t)}be.addEventListener("change",Ot);async function Ot(e){const t=e?e.target.files[0]:be.files[0];if(!t)return;oe=t.name.replace(".pdf",""),Lt.textContent=Ve(t.name),Xt(t);const n=await t.arrayBuffer();if(N=1,k=[],A=[],$=-1,C.clear(),J.clear(),D=await Qe.load(n,{ignoreEncryption:!0}),T=await et({data:new Uint8Array(n)}).promise,ue.max=T.numPages,De.classList.remove("hidden"),Ne.classList.add("hidden"),st.checked){const i=await Ke(D);i.length>0&&(k=i)}G?(k=G,G=null):Q&&(k=Q,Q=null),O(),B(),F(N),ce({icons:de})}Ce.addEventListener("change",async e=>{const t=e.target.files[0];if(!t)return;const n=await t.text();G=Ze(n),await q("CSV Loaded",`Loaded ${G.length} bookmarks from CSV. Now upload your PDF.`)});Pe.addEventListener("change",async e=>{const t=e.target.files[0];if(!t)return;const n=await t.text();try{Q=JSON.parse(n),await q("JSON Loaded","Loaded bookmarks from JSON. Now upload your PDF.")}catch{await q("Error","Invalid JSON format")}});async function F(e,t=null,n=null,o=null){if(!T)return;const i=await T.getPage(e);let l=U;t!==null&&t!==""&&t!=="0"&&(l=parseFloat(t)/100);const x=window.devicePixelRatio||1;let f=i.getViewport({scale:l});if(Se=f,_.height=f.height*x,_.width=f.width*x,_.style.width=f.width+"px",_.style.height=f.height+"px",w.scale(x,x),await i.render({canvasContext:w,viewport:f}).promise,n!==null&&o!==null){const c=n,b=f.height-o;w.save(),w.strokeStyle="#3b82f6",w.fillStyle="#3b82f6",w.lineWidth=3,w.shadowBlur=10,w.shadowColor="rgba(59, 130, 246, 0.5)",w.beginPath(),w.arc(c,b,12,0,2*Math.PI),w.fill(),w.shadowBlur=0,w.beginPath(),w.moveTo(c-15,b),w.lineTo(c+15,b),w.moveTo(c,b-15),w.lineTo(c,b+15),w.stroke(),w.beginPath(),w.arc(c,b,6,0,2*Math.PI),w.fill(),w.stroke();const d=`X: ${Math.round(n)}, Y: ${Math.round(o)}`;w.font="bold 12px monospace";const h=w.measureText(d).width,u=18;w.fillStyle="rgba(59, 130, 246, 0.95)",w.fillRect(c+18,b-25,h+10,u),w.fillStyle="white",w.fillText(d,c+23,b-10),w.restore()}at.textContent=`Page ${e} / ${T.numPages}`,ue.value=e,N=e,wt.textContent=e}async function je(e,t,n,o){await F(e,o,t,n)}it.addEventListener("click",()=>{N>1&&F(N-1)});rt.addEventListener("click",()=>{N<T.numPages&&F(N+1)});Me.addEventListener("click",()=>{const e=parseInt(ue.value);e>=1&&e<=T.numPages&&F(e)});ue.addEventListener("keypress",e=>{e.key==="Enter"&&Me.click()});function ge(){Ie&&(Ie.textContent=`${Math.round(U*100)}%`)}ct.addEventListener("click",()=>{U=Math.min(U+.05,2),ge(),F(N)});dt.addEventListener("click",()=>{U=Math.max(U-.05,.25),ge(),F(N)});ut.addEventListener("click",async()=>{T&&(U=1,ge(),F(N))});ge();ft.addEventListener("input",e=>{W=e.target.value.toLowerCase(),B()});function Fe(e,t){for(let n=0;n<e.length;n++){if(e[n].id===t)return e.splice(n,1),!0;if(Fe(e[n].children,t))return!0}return!1}function Re(e,t=0){let n=[];for(const o of e)n.push({...o,level:t}),o.children.length>0&&(n=n.concat(Re(o.children,t+1)));return n}function Ae(e,t){return!t||e.title.toLowerCase().includes(t)?!0:e.children.some(n=>Ae(n,t))}function Je(e,t=null,n=!1){new tt(e,{group:n?"top-level-only":"nested-level-"+(t?t.id:"none"),animation:150,handle:"[data-drag-handle]",ghostClass:"sortable-ghost",dragClass:"sortable-drag",forceFallback:!0,fallbackTolerance:3,onEnd:function(o){try{if(o.oldIndex===o.newIndex){B();return}const i=JSON.parse(JSON.stringify(k));if(n){const l=i.splice(o.oldIndex,1)[0];i.splice(o.newIndex,0,l),k=i}else if(t){const l=He(i,t.id);if(l&&l.children){const x=l.children.splice(o.oldIndex,1)[0];l.children.splice(o.newIndex,0,x),k=i}else{B();return}}O(),B()}catch(i){console.error("Error in drag and drop:",i),$>0&&(k=JSON.parse(JSON.stringify(A[$]))),B()}}})}function He(e,t){if(!e||!Array.isArray(e))return null;for(const n of e){if(n.id===t)return n;if(n.children&&n.children.length>0){const o=He(n.children,t);if(o)return o}}return null}function Yt(e){return e==="bold"?"font-bold":e==="italic"?"italic":e==="bold-italic"?"font-bold italic":""}function jt(e){return!e||e.startsWith("#")?"":{red:"text-red-600",blue:"text-blue-600",green:"text-green-600",yellow:"text-yellow-600",purple:"text-purple-600"}[e]||""}function B(){fe.innerHTML="";const e=W?k.filter(t=>Ae(t,W)):k;if(e.length===0)Be.classList.remove("hidden");else{Be.classList.add("hidden");for(const t of e)fe.appendChild(Ue(t));Je(fe,null,!0)}ce({icons:de}),K()}function Ue(e,t=0){if(!e||!e.id)return console.error("Invalid node:",e),document.createElement("li");const n=document.createElement("li");n.dataset.bookmarkId=e.id,n.className="group";const o=e.children&&Array.isArray(e.children)&&e.children.length>0,i=J.has(e.id),l=C.has(e.id),f=(!W||e.title.toLowerCase().includes(W))&&W?"bg-yellow-100":"",c=e.color&&$t[e.color]||"",b=Yt(e.style),d=jt(e.color),p=document.createElement("div");if(p.className=`flex items-center gap-2 p-2 rounded border border-gray-200 ${c} ${f} ${l?"ring-2 ring-blue-500":""} hover:bg-gray-50`,Z){const a=document.createElement("input");a.type="checkbox",a.checked=l,a.className="w-4 h-4 flex-shrink-0",a.addEventListener("click",m=>{m.stopPropagation(),C.has(e.id)?C.delete(e.id):C.add(e.id),K(),a.checked=C.has(e.id),ke.classList.toggle("hidden",!Z||C.size===0)}),p.appendChild(a)}const h=document.createElement("div");if(h.dataset.dragHandle="true",h.className="cursor-move flex-shrink-0",h.innerHTML='<i data-lucide="grip-vertical" class="w-4 h-4 text-gray-400"></i>',p.appendChild(h),o){const a=document.createElement("button");a.className="p-0 flex-shrink-0",a.innerHTML=i?'<i data-lucide="chevron-right" class="w-4 h-4"></i>':'<i data-lucide="chevron-down" class="w-4 h-4"></i>',a.addEventListener("click",m=>{m.stopPropagation(),J.has(e.id)?J.delete(e.id):J.add(e.id),B()}),p.appendChild(a)}else{const a=document.createElement("div");a.className="w-4 flex-shrink-0",p.appendChild(a)}const u=document.createElement("div");u.className="flex-1 min-w-0 cursor-pointer";const r=e.color&&e.color.startsWith("#")?`style="color: ${e.color}"`:"",E=e.destX!==null||e.destY!==null||e.zoom!==null?'<i data-lucide="crosshair" class="w-3 h-3 inline-block ml-1 text-blue-500"></i>':"";u.innerHTML=`
                <span class="text-sm block ${b} ${d}" ${r}>${We(e.title)}${E}</span>
                <span class="text-xs text-gray-500">Page ${e.page}</span>
            `,u.addEventListener("click",async()=>{e.destX!==null||e.destY!==null||e.zoom!==null?(await je(e.page,e.destX,e.destY,e.zoom),setTimeout(()=>{e.zoom!==null&&e.zoom!==""&&e.zoom!=="0"?setTimeout(()=>{F(e.page)},1e3):F(e.page)},2e3)):F(e.page),window.innerWidth<1024&&R.click()}),p.appendChild(u);const S=document.createElement("div");S.className="flex gap-1 flex-shrink-0";const M=document.createElement("button");M.className="p-1 hover:bg-gray-200 rounded",M.title="Add child",M.innerHTML='<i data-lucide="plus" class="w-4 h-4"></i>',M.addEventListener("click",async a=>{a.stopPropagation();const m=await Ee("Add Child Bookmark",[{type:"text",name:"title",label:"Title",placeholder:"Enter bookmark title"}]);m&&m.title&&(e.children.push({id:Date.now()+Math.random(),title:m.title,page:N,children:[],color:null,style:null,destX:null,destY:null,zoom:null}),J.delete(e.id),O(),B())}),S.appendChild(M);const P=document.createElement("button");P.className="p-1 hover:bg-gray-200 rounded",P.title="Edit",P.innerHTML='<i data-lucide="edit-2" class="w-4 h-4"></i>',P.addEventListener("click",async a=>{a.stopPropagation();const m=await Ee("Edit Bookmark",[{type:"text",name:"title",label:"Title",placeholder:"Enter bookmark title"},{type:"select",name:"color",label:"Color",options:[{value:"",label:"None"},{value:"red",label:"Red"},{value:"blue",label:"Blue"},{value:"green",label:"Green"},{value:"yellow",label:"Yellow"},{value:"purple",label:"Purple"},{value:"custom",label:"Custom..."}]},{type:"select",name:"style",label:"Style",options:[{value:"",label:"Normal"},{value:"bold",label:"Bold"},{value:"italic",label:"Italic"},{value:"bold-italic",label:"Bold & Italic"}]},{type:"destination",label:"Destination",page:e.page,maxPages:T?T.numPages:1},{type:"preview",label:"Preview"}],{title:e.title,color:e.color||"",style:e.style||"",destPage:e.page,destX:e.destX,destY:e.destY,zoom:e.zoom});m&&(e.title=m.title,e.color=m.color||null,e.style=m.style||null,m.destPage!==null&&m.destPage!==void 0&&(e.page=m.destPage,e.destX=m.destX,e.destY=m.destY,e.zoom=m.zoom),O(),B())}),S.appendChild(P);const s=document.createElement("button");if(s.className="p-1 hover:bg-gray-200 rounded text-red-600",s.title="Delete",s.innerHTML='<i data-lucide="trash-2" class="w-4 h-4"></i>',s.addEventListener("click",async a=>{a.stopPropagation(),await ee(`Delete "${e.title}"?`)&&(Fe(k,e.id),O(),B())}),S.appendChild(s),p.appendChild(S),n.appendChild(p),o&&!i){const a=document.createElement("ul");a.className="child-container space-y-2";const m=JSON.parse(JSON.stringify(e));for(const g of e.children)g&&g.id&&a.appendChild(Ue(g,t+1));n.appendChild(a),Je(a,m,!1)}return n}ze.addEventListener("click",async()=>{const e=he.value.trim();if(!e){await q("Error","Please enter a title.");return}k.push({id:Date.now(),title:e,page:N,children:[],color:null,style:null,destX:null,destY:null,zoom:null}),O(),B(),he.value=""});he.addEventListener("keypress",e=>{e.key==="Enter"&&ze.click()});function We(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}vt.addEventListener("click",()=>{ye.click(),te.classList.add("hidden")});ye.addEventListener("change",async e=>{const t=e.target.files[0];if(!t)return;const n=await t.text(),o=Ze(n);o.length>0&&(k=o,O(),B(),await q("Success",`Imported ${o.length} bookmarks!`)),ye.value=""});bt.addEventListener("click",()=>{if(ne.classList.add("hidden"),k.length===0){q("Error","No bookmarks to export!");return}const t=`title,page,level
`+Re(k).map(l=>`"${l.title.replace(/"/g,'""')}",${l.page},${l.level}`).join(`
`),n=new Blob([t],{type:"text/csv"}),o=URL.createObjectURL(n),i=document.createElement("a");i.href=o,i.download=`${oe}-bookmarks.csv`,i.click(),URL.revokeObjectURL(o)});function Ze(e){const t=e.trim().split(`
`).slice(1),n=[],o=[{children:n,level:-1}];for(const i of t){const l=i.match(/^"(.+)",(\d+),(\d+)$/)||i.match(/^([^,]+),(\d+),(\d+)$/);if(!l)continue;const[,x,f,c]=l,b={id:Date.now()+Math.random(),title:x.replace(/""/g,'"'),page:parseInt(f),children:[],color:null,style:null,destX:null,destY:null,zoom:null},d=parseInt(c);for(;o[o.length-1].level>=d;)o.pop();o[o.length-1].children.push(b),o.push({...b,level:d})}return n}kt.addEventListener("click",()=>{ve.click(),te.classList.add("hidden")});ve.addEventListener("change",async e=>{const t=e.target.files[0];if(!t)return;const n=await t.text();try{k=JSON.parse(n),O(),B(),await q("Success","Bookmarks imported from JSON!")}catch{await q("Error","Invalid JSON format")}ve.value=""});xt.addEventListener("click",()=>{if(ne.classList.add("hidden"),k.length===0){q("Error","No bookmarks to export!");return}const e=JSON.stringify(k,null,2),t=new Blob([e],{type:"application/json"}),n=URL.createObjectURL(t),o=document.createElement("a");o.href=n,o.download=`${oe}-bookmarks.json`,o.click(),URL.revokeObjectURL(n)});Et.addEventListener("click",async()=>{if(!D)return;const e=await Ke(D);e.length>0?await ee(`Found ${e.length} existing bookmarks. Replace current bookmarks?`)&&(k=e,O(),B()):await q("Info","No existing bookmarks found in this PDF.")});async function Ke(e){try{let t=function(d){return d?d.lookup?d:d.objectNumber!==void 0&&e.context?e.context.lookup(d):d:null},n=function(d,p=null){if(!d)return 0;try{if(p){for(let u=0;u<x.length;u++)if(e.context.lookup(x[u].ref)===p)return u}const h=x.findIndex(u=>u.ref===d);if(h!==-1)return h;if(!p){const u=t(d);if(u){for(let r=0;r<x.length;r++)if(e.context.lookup(x[r].ref)===u)return r}}if(d.toString){const u=d.toString(),r=x.findIndex(y=>y.ref&&y.ref.toString()===u);if(r!==-1)return r}if(d.numberValue!==void 0){const u=d.numberValue|0;if(u>=0&&u<x.length)return u}}catch(h){console.error("Error finding page index:",h)}return 0},o=function(d){if(!d)return null;let p=d.lookup(v.of("Dest"));if(!p){const h=t(d.lookup(v.of("A")));h&&(p=h.lookup(v.of("D")))}if(p&&!p.array)try{const h=p.decodeText?p.decodeText():p.toString();if(f.has(h)){const u=f.get(h);if(u.array)p=u;else if(u.lookup){const r=u.lookup(v.of("D"));r?p=r:p=u}else p=u}else if(p.lookup){const u=t(p),r=u&&u.lookup?u.lookup(v.of("D")):null;r&&(p=t(r))}}catch{}return p},i=function(d){if(!d||(d=t(d),!d))return null;const p=d.lookup(v.of("Title")),h=o(d),u=d.lookup(v.of("C")),r=d.lookup(v.of("F"));let y=0,E=null,S=null,M=null;if(h&&h.array){const g=h.array[0],L=t(g);if(y=n(g,L),h.array.length>2){const I=t(h.array[2]),Y=t(h.array[3]),z=t(h.array[4]);I&&I.numberValue!==void 0&&(E=I.numberValue),Y&&Y.numberValue!==void 0&&(S=Y.numberValue),z&&z.numberValue!==void 0&&(M=String(Math.round(z.numberValue*100)))}}let P=null;if(u&&u.array){const[g,L,I]=u.array;g>.8&&L<.3&&I<.3?P="red":g<.3&&L<.3&&I>.8?P="blue":g<.3&&L>.8&&I<.3?P="green":g>.8&&L>.8&&I<.3?P="yellow":g>.5&&L<.5&&I>.5&&(P="purple")}let s=null;if(r){const g=r.numberValue||0,L=(g&2)!==0,I=(g&1)!==0;L&&I?s="bold-italic":L?s="bold":I&&(s="italic")}const a={id:Date.now()+Math.random(),title:p?p.decodeText():"Untitled",page:y+1,children:[],color:P,style:s,destX:E,destY:S,zoom:M};let m=t(d.lookup(v.of("First")));for(;m;){const g=i(m);g&&a.children.push(g),m=t(m.lookup(v.of("Next")))}if(y===0&&a.children.length>0){const g=a.children[0];g&&(a.page=g.page,a.destX=g.destX,a.destY=g.destY,a.zoom=g.zoom)}return a};const l=e.catalog.lookup(v.of("Outlines"));if(!l)return[];const x=e.getPages(),f=new Map;try{let d=function(r,y){try{const E=r.decodeText?r.decodeText():String(r);f.set(E,t(y))}catch{}},p=function(r){if(!r||(r=t(r),!r))return;const y=r.lookup?r.lookup(v.of("Names")):null;if(y&&y.array)for(let S=0;S<y.array.length;S+=2){const M=y.array[S],P=y.array[S+1];d(M,P)}const E=r.lookup?r.lookup(v.of("Kids")):null;if(E&&E.array)for(const S of E.array)p(S)};const h=e.catalog.lookup(v.of("Names"));if(h){const r=h.lookup(v.of("Dests"));r&&p(r)}const u=e.catalog.lookup(v.of("Dests"));if(u&&u.dict){const r=u.dict.entries();for(const[y,E]of r){const S=y.decodeText?y.decodeText():y.toString();f.set(S,t(E))}}}catch(d){console.error("Error building named destinations:",d)}const c=[];let b=t(l.lookup(v.of("First")));for(;b;){const d=i(b);d&&c.push(d),b=t(b.lookup(v.of("Next")))}return c}catch(t){return console.error("Error extracting bookmarks:",t),[]}}we&&we.addEventListener("click",()=>{window.location.href="/"});Le&&Le.addEventListener("click",()=>{window.location.href="/"});mt.addEventListener("click",async()=>{const e=D.getPages(),t=D.context.obj({}),n=D.context.register(t);function o(i,l){const x=[];for(let f=0;f<i.length;f++){const c=i[f],b=D.context.obj({}),d=D.context.register(b);b.set(v.of("Title"),nt.of(c.title)),b.set(v.of("Parent"),l);const p=Math.max(0,Math.min(c.page-1,e.length-1)),h=e[p].ref;let u;if(c.destX!==null||c.destY!==null||c.zoom!==null){const r=c.destX!==null?le.of(c.destX):null,y=c.destY!==null?le.of(c.destY):null;let E=null;c.zoom!==null&&c.zoom!==""&&c.zoom!=="0"&&(E=le.of(parseFloat(c.zoom)/100)),u=D.context.obj([h,v.of("XYZ"),r,y,E])}else u=D.context.obj([h,v.of("XYZ"),null,null,null]);if(b.set(v.of("Dest"),u),c.color){let r;if(c.color.startsWith("#")){const y=c.color.replace("#",""),E=parseInt(y.substr(0,2),16)/255,S=parseInt(y.substr(2,2),16)/255,M=parseInt(y.substr(4,2),16)/255;r=[E,S,M]}else r={red:[1,0,0],blue:[0,0,1],green:[0,1,0],yellow:[1,1,0],purple:[.5,0,.5]}[c.color];if(r){const y=D.context.obj(r);b.set(v.of("C"),y)}}if(c.style){let r=0;c.style==="italic"?r=1:c.style==="bold"?r=2:c.style==="bold-italic"&&(r=3),r>0&&b.set(v.of("F"),le.of(r))}if(c.children.length>0){const r=o(c.children,d);r.length>0&&(b.set(v.of("First"),r[0].ref),b.set(v.of("Last"),r[r.length-1].ref),b.set(v.of("Count"),D.context.obj(r.length)))}f>0&&(b.set(v.of("Prev"),x[f-1].ref),x[f-1].dict.set(v.of("Next"),d)),x.push({ref:d,dict:b})}return x}try{const i=o(k,n);i.length>0&&(t.set(v.of("Type"),v.of("Outlines")),t.set(v.of("First"),i[0].ref),t.set(v.of("Last"),i[i.length-1].ref),t.set(v.of("Count"),D.context.obj(i.length))),D.catalog.set(v.of("Outlines"),n);const l=await D.save(),x=new Blob([l],{type:"application/pdf"}),f=URL.createObjectURL(x),c=document.createElement("a");c.href=f,c.download=`${oe}-bookmarked.pdf`,c.click(),URL.revokeObjectURL(f),await q("Success","PDF saved successfully!"),setTimeout(()=>{Oe()},500)}catch(i){console.error(i),await q("Error","Error saving PDF. Check console for details.")}});
